name: Generate Android Keystore & Build Signed

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: Keystore alias
        required: false
        default: learn
      common_name:
        description: Certificate CN
        required: false
        default: LearnForKids
      org_unit:
        description: Certificate OU
        required: false
        default: Dev
      org:
        description: Certificate O
        required: false
        default: LFK
      city:
        description: Certificate L (City)
        required: false
        default: Shenzhen
      state:
        description: Certificate S (State)
        required: false
        default: Guangdong
      country:
        description: Certificate C (Country Code)
        required: false
        default: CN

jobs:
  build-signed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Generate random passwords
        id: pw
        run: |
          echo "STORE_PW=$(openssl rand -hex 16)" >> $GITHUB_OUTPUT
          echo "KEY_PW=$(openssl rand -hex 16)" >> $GITHUB_OUTPUT

      - name: Generate keystore
        run: |
          mkdir -p android-sign
          keytool -genkeypair -v \
            -keystore android-sign/learn.jks \
            -alias "${{ github.event.inputs.key_alias }}" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "${{ steps.pw.outputs.STORE_PW }}" \
            -keypass "${{ steps.pw.outputs.KEY_PW }}" \
            -dname "CN=${{ github.event.inputs.common_name }}, OU=${{ github.event.inputs.org_unit }}, O=${{ github.event.inputs.org }}, L=${{ github.event.inputs.city }}, S=${{ github.event.inputs.state }}, C=${{ github.event.inputs.country }}"

      - name: Create key.properties for signing
        run: |
          cat > key.properties <<'EOF'
          storeFile=android-sign/learn.jks
          storePassword=${{ steps.pw.outputs.STORE_PW }}
          keyAlias=${{ github.event.inputs.key_alias }}
          keyPassword=${{ steps.pw.outputs.KEY_PW }}
          EOF

      - name: Build signed APK
        run: flutter build apk --release

      - name: Build signed AppBundle
        run: flutter build appbundle

      - name: Export key info
        run: |
          cat > android-sign/key-info.txt <<EOF
          Keystore Path: android-sign/learn.jks
          Key Alias: ${{ github.event.inputs.key_alias }}
          Store Password: ${{ steps.pw.outputs.STORE_PW }}
          Key Password: ${{ steps.pw.outputs.KEY_PW }}
          EOF

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release-signed
          path: build/app/outputs/apk/release/app-release.apk

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release-signed
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Upload keystore & key info
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore-and-info
          path: |
            android-sign/learn.jks
            android-sign/key-info.txt